1. 核心功能逻辑 (Core Logic)
1.1 审计逻辑 (Audit Engine)
输入： 通过 Shopify Admin API 读取 Products 和 Theme Assets。

筛选规则：

文件大小 > 500KB。

格式为 PNG, JPG, GIF。

排序： 按 File Size 降序排列，取 Top 50。

计算公式（前端展示用）：

节省时间 (s) = (当前体积 - 预估WebP体积) / 1.5MB

注：预估 WebP 体积按原图体积的 20% 计算。

1.2 修复逻辑 (Fix Engine - Closed Loop)
触发： 用户点击单个“Fix”按钮。

后端执行流：

Fetch: 下载原图到内存。

Backup (强制): 上传原图至 AWS S3，获取 s3_url。

Compress: 压缩图片 (转 WebP, Quality 80%)。

Update: 调用 Shopify API (productImageUpdate) 使用新图 URL 覆盖旧图。

状态更新： 数据库写入日志，前端更新为“已修复”状态。

1.3 限制与还原 (Limit & Revert)
Free Plan： 每日 API 调用限制为 3 次（3 张图）。

Pro Plan： 无限制。

还原功能： 读取数据库中的 s3_url，再次调用 Shopify API 覆盖回原图。

2. 交互与 UI 规范 (UX/UI Specs)
组件库： 必须使用 @shopify/polaris。

2.1 初始页 (Dashboard - Empty)
元素：

EmptyState 组件。

主按钮："Start Speed Audit"。

2.2 扫描过程 (Loading)
元素：

ProgressBar (0% -> 100%, 耗时约 5-8s)。

下方文本动态切换："Fetching Assets..." -> "Analyzing Sizes..."。

2.3 结果页 (Report Workspace) - 核心页
布局： 上下结构。

A. 顶部记分板 (Scorecard):

显示总评级 (如 "D")。

显示关键指标：Total Heavy Images (数量), Potential Time Saved (秒数)。

B. 列表区 (ResourceList):

Item 布局：

Thumbnail (左侧): 显示图片缩略图。

Text (中间): 显示 5.2MB (PNG) ➔ 400KB (WebP)。

Badge (中间): 红色高亮显示 Slows down 0.8s。

Button (右侧): "Fix"。

交互状态：

点击 "Fix" -> 按钮变 Spinner -> 成功变 Icon (Checkmark)。

C. 付费墙 (Upsell Modal):

触发： 点击第 4 个 "Fix" 按钮时。

动作： 阻断操作，弹出 Modal 提示升级 Pro。

3. 数据结构 (Database Schema)
数据库： PostgreSQL

3.1 表结构：imagelogs (核心资产表)
用于记录每一张被修改的图片，确保可还原。

字段名	类型	说明
id	UUID	主键
shop_domain	String	店铺域名 (索引)
shopify_asset_id	String	Shopify 侧图片 ID
original_s3_key	String	S3 备份路径 (必须)
original_size	Int	原图大小 (Bytes)
optimized_size	Int	优化后大小 (Bytes)
status	Enum	optimized, reverted
created_at	Timestamp	操作时间

Export to Sheets

4. 技术架构 (Architecture)
Plaintext

[ Shopify Admin (前端) ]
       |
       |  (点击 "Fix")
       v
[ App Server (Node.js) ]
       |
       |--- 1. 下载原图 ---> [ 内存 ]
       |
       |--- 2. 备份原图 ---> [ AWS S3 ] (存入 original_s3_key)
       |
       |--- 3. 压缩处理 ---> [ Sharp / ImageMagick ]
       |
       |--- 4. 回写覆盖 ---> [ Shopify Admin API ] (PUT /admin/api/products/images/{id}.json)
       |
       v
[ Database (PostgreSQL) ] (写入操作日志)
5. 权限要求 (Scopes)
在 Shopify Partner 后台配置 App 时，必须申请以下权限：

read_products, write_products (读写商品图)

read_themes, write_themes (读写主题资源图)

read_content, write_content (读写文件部分)